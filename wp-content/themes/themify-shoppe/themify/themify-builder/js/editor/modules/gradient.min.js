(($,r,C,v)=>{'use strict';$.ThemifyGradient=function(h,t){const e={gradient:$.ThemifyGradient.default,width:173,height:15,point:8,angle:180,circle:!1,type:'linear',onChange(){},onInit(){}},l=$(h);let d,g,f,p,u,m,_,y=[];return this.isInit=!1,this.initSwatchesFlag=!1,this.settings={},this.__constructor=function(){return this.settings=Object.assign({},e,t),this.update(),this.settings.onInit(),this.isInit=!0,this},this.updateSettings=function(t){return this.settings=Object.assign({},e,t),this.update(),this},this.update=function(){this._setupPoints(),this._setup(),this._render()},this.getCSSvalue=function(){const i=[],t='radial'===this.settings.type?this.settings.circle?'circle,':'':this.settings.angle+'deg,';for(let t=0,e=y.length;t<e;++t)i.push(y[t][1]+' '+y[t][0]);return this.settings.type+'-gradient('+t+i.join(', ')+')'},this.getString=function(){let i='';for(let t=0,e=y.length;t<e;++t)i+=y[t][0]+' '+y[t][1]+'|';return i.substr(0,i.length-1)},this.setType=function(t){this.settings.type=t,this.settings.onChange(this.getString(),this.getCSSvalue())},this.setAngle=function(t){this.settings.angle=t,this.settings.onChange(this.getString(),this.getCSSvalue())},this.setRadialCircle=function(t){this.settings.circle=t,this.settings.onChange(this.getString(),this.getCSSvalue())},this._setupPoints=function(){y=[],y=Array.isArray(this.settings.gradient)?this.settings.gradient:this._getGradientFromString(this.settings.gradient)},this._setup=function(){const a=this,t=C.createDocumentFragment(),e=C.createElement('div'),i=C.createElement('div'),s=C.createElement('span'),n=C.createElement('span'),r=C.createElement('div'),o=C.createElement('div'),c=h.tfClass('themifyGradient')[0];u=C.createElement('a'),f=C.createElement('div'),p=C.createElement('input'),d=C.createElement('div'),g=C.createElement('div');let l=C.createElement('canvas');e.className='themifyGradient tf_rel',e.tabIndex='-1',l.width=this.settings.width,l.height=this.settings.height,d.className='points',f.className='point-color',s.className='gradient_delimiter',n.className='gradient_percent',n.innerHTML='%',p.type='text',p.className='point-position',u.className='gradient-point-delete tf_close',u.href='#',i.className='gradient-pointer-info',g.className='content',r.style.backgroundColor='#00ff00',o.className='gradient-pointer-arrow',f.appendChild(r),g.append(f,s,p,n,u),i.append(o,g),t.append(d,l,i),e.appendChild(t),c&&c.remove(),h.prepend(e),h.tfClass('tb_gradient_swatches')[0]||(h.appendChild(this.swatchesHTML()),this.initSwatches()),g=$(g),f=$(f),p=$(p),u=$(u),d=$(d),m=l.getContext('2d'),(l=$(l)).off('click').on('click',function(t){const e=$(this).offset();let i='rgba(0,0,0, 1)',s=999999999999,n=t.pageX-e.left;n=Math.round(100*n/a.settings.width);for(let t=0,e=y.length;t<e;++t)y[t][0]=parseInt(y[t][0]),y[t][0]<n&&n-y[t][0]<s?(s=n-y[t][0],i=y[t][1]):y[t][0]>n&&y[t][0]-n<s&&(s=y[t][0]-n,i=y[t][1]);y.push([n+'%',i]),y.sort(a._sortByPosition),a._render();for(let t=0,e=y.length;t<e;++t)y[t][0]===n+'%'&&a._selectPoint(d.find('.point:eq('+t+')')[0]);'visual'===v.mode&&setTimeout(a._colorPickerPosition,315)}),this.pointEvents()},this.pointEvents=function(){const c=this;g[0].tfOn('focusout keyup',e=>{const i=e.target;if(i.classList.contains('point-position')){let t=parseInt(i.value.trim());isNaN(t)?t=0:t<0?t=Math.abs(t):98<=t&&(t=98),'focusout'!==e.type?(t=Math.round(t*this.settings.width/100),$(i).closest('.themifyGradient').find('.themify_current_point').css('left',t),this._renderCanvas()):i.value=t}},{passive:!1}),d[0].tfOn('keyup',t=>{'Delete'===t.code&&'INPUT'!==C.activeElement.tagName&&(p.focus(),this.removePoint(t))},{passive:!1}).tfOn(r.click,t=>{t.target.classList.contains('point')&&(this._selectPoint(t.target),'visual'===v.mode&&this._colorPickerPosition())},{passive:!0}).tfOn('pointerdown',function(t){if(1===t.which&&t.target.classList.contains('point')){t.stopImmediatePropagation();let i;const s=t.target,e=t=>{h.focus(),s.classList.add('tb_gradient_drag_point'),C.body.classList.add('tb_start_animate','tb_move_drag','tb_gradient_drag')},n=c.settings.width,a=parseFloat(window.getComputedStyle(s).getPropertyValue('margin-left'))||0,r=s.offsetLeft-t.clientX,o=e=>{e.stopImmediatePropagation(),i=requestAnimationFrame(()=>{let t=r+e.clientX-a;t>n?t=n:t<0&&(t=0),s.style.left=t+'px',c._selectPoint(s,!0),c._renderCanvas()})};s.tfOn('lostpointercapture',function(t){i&&cancelAnimationFrame(i),t.stopImmediatePropagation(),this.tfOff('pointermove',e,{passive:!0,once:!0}).tfOff('pointermove',o,{passive:!0}),C.body.classList.remove('tb_start_animate','tb_move_drag','tb_gradient_drag'),this.classList.remove('tb_gradient_drag_point'),h.focus(),i=null},{passive:!0,once:!0}).tfOn('pointermove',e,{passive:!0,once:!0}).tfOn('pointermove',o,{passive:!0}).setPointerCapture(t.pointerId)}},{passive:!0})},this._render=function(){this._initGradientPoints(),this._renderCanvas()},this._colorPickerPosition=function(){const t=$(v.LightBox.el),e=g.find('.tfminicolors'),i=e.find('.tfminicolors-panel');0<i.length&&(t.offset().left+t.width()<=i.offset().left+i.width()?e.addClass('tb_minicolors_right'):e.removeClass('tb_minicolors_right'))},this._initGradientPoints=function(){const i=C.createDocumentFragment();for(;d[0].firstChild;)d[0].lastChild.remove();for(let e=0,t=y.length;e<t;++e){let t=C.createElement('div');t.className='point',t.style.backgroundColor=y[e][1],t.style.left=parseInt(y[e][0])*this.settings.width/100+'px',i.appendChild(t)}d[0].appendChild(i)},this.hexToRgb=function(t){t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(t,e,i,s)=>e+e+i+i+s+s);const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null},this._selectPoint=function(r,o){if(r){const c=this;let t=parseInt(r.style.left);if(p.val(Math.round(t/this.settings.width*100)),(t-=30)<0&&C.body.classList.contains('tb_module_panel_docked')&&(t=3),g[0].parentNode.style.marginLeft=t+'px',o)return!1;l.focus(),(_=$(r)).addClass('themify_current_point').siblings().removeClass('themify_current_point');let e=_.css('backgroundColor'),i=e.substr(4,e.length),s=(i=i.substr(0,i.length-1),l.find('.point-color .tfminicolors').remove(),f.find('.themify-color-picker')),n=(0===s.length&&((s=$('<input type="text" class="themify-color-picker" />')).appendTo(f).tfminicolors({opacity:!0,changeDelay:10,change(t,e){let i=c.hexToRgb(t);i||(i={r:255,g:255,b:255},e=1),_.css('backgroundColor','rgba('+i.r+','+i.g+','+i.b+','+e+')'),c._renderCanvas()}}),l.find('.tfminicolors').first().addClass('tfminicolors-focus'),u.off('click').on('click',this.removePoint.bind(this))),e.replace(/^rgba?\(|\s+|\)$/g,'').split(',')),a=4===n.length?n.pop():1;n=this._rgbToHex(n),s.val(n).attr('data-opacity',a).data('opacity',a).tfminicolors('settings',{value:n})}},this._renderCanvas=function(){const i=d[0].tfClass('point');y=[];for(let e=0,t=i.length;e<t;++e){let t=Math.round(parseInt(i[e].style.left)/this.settings.width*100);y.push([t+'%',i[e].style.backgroundColor])}y.sort(this._sortByPosition),this._renderToCanvas(),this.isInit&&this.settings.onChange(this.getString(),this.getCSSvalue())},this._renderToCanvas=function(){const i=m.createLinearGradient(0,0,this.settings.width,0);for(let t=0,e=y.length;t<e;++t)i.addColorStop(parseInt(y[t][0])/100,y[t][1]);m.clearRect(0,0,this.settings.width,this.settings.height),m.fillStyle=i,m.fillRect(0,0,this.settings.width,this.settings.height)},this._getGradientFromString=function(t){const a=[],r=t.split('|');for(let n=0,t=r.length;n<t;++n){let t,e=r[n],i=e.indexOf('%'),s=e.substr(i-3,i);'100'===s||'100%'===s?t='100%':(t=1<i?parseInt(e.substr(i-2,i)):parseInt(e.substr(i-1,i)),t+='%'),a.push([t,e.replace(t,'')])}return a},this._rgbToHex=function(t){const e=t[0],i=t[1],s=t[2];function n(t){return t=parseInt(t,10),isNaN(t)?'00':(t=Math.max(0,Math.min(t,255)),'0123456789ABCDEF'.charAt((t-t%16)/16)+'0123456789ABCDEF'.charAt(t%16))}return'#'+n(e)+n(i)+n(s)},this._sortByPosition=function(t,e){return(t=parseInt(t[0]))<(e=parseInt(e[0]))?-1:e<t?1:0},this.removePoint=function(t){if(t.preventDefault(),1<y.length){y.splice(_.index(),1);const e=g[0].parentNode;e.style.display='none',setTimeout(()=>{e.style.display=''},50),this._render()}},this.swatchesHTML=function(){const t=C.createDocumentFragment(),e=C.createElement('div'),i=C.createElement('ul'),s=themifyColorManager.makeImportExportDropdown(),n=C.createElement('button');n.className='tb_gradient_add_swatch tf_plus_icon';let a=C.createElement('span');return a.className='themify_tooltip',a.innerText=ThemifyConstructor.label.save_gradient,n.button='button',n.appendChild(a),n.tfOn(r.click,this.saveSwatch.bind(this)),e.className='tf_cm_dropdown_icon',e.tabIndex=1,(a=C.createElement('span')).className='themify_tooltip',a.innerText=ThemifyConstructor.label.ie_gradient,s.tfOn(r.click,t=>{this.swatchesDropdownClicked(t)}),e.append(a,v.Helper.getIcon('ti-import'),s),i.className='tb_gradient_swatches tf_scrollbar tf_w',i.tfOn(r.click,t=>{this.swatchClicked(t)}),t.append(n,e,i),t},this.swatchesDropdownClicked=function(t){t.preventDefault(),t.stopPropagation();const e=t.target,i=e.classList;i.contains('tb_cm_export')?(e.parentNode.parentNode.parentNode.blur(),C.location.assign(themifyCM.exportGradientsURL)):i.contains('tb_cm_import')&&(e.parentNode.parentNode.parentNode.blur(),themifyColorManager.importColors('gradients'))},this.saveSwatch=function(){if(''===this.getString()||''===this.getCSSvalue())return!1;const e=Object.keys(themifyCM.gradients),i=this.getCSSvalue();for(let t=e.length-1;-1<t;--t)if(themifyCM.gradients[e[t]].css===i)return null;const t=themifyColorManager.UID(),s={id:t,setting:JSON.parse(JSON.stringify(this.settings)),gradient:this.getString(),css:i,points:y};themifyCM.gradients[t]=s,this.addSwatch(s),themifyColorManager.updateColorSwatches('gradients')},this.addSwatch=function(t,e){const i=C.createElement('li'),s=C.createElement('span');if(i.className='tb_gradient_swatch',i.style.background=t.css,i.dataset.id=t.id,s.className='tf_delete_swatch tf_close',i.appendChild(s),e){const n=h.parentElement.tfClass('tb_gradient_swatches')[0];n.insertBefore(i,n.firstChild)}else{const a=v.LightBox.el.tfClass('tb_gradient_swatches');for(let t=0,e=a.length;t<e;++t)a[t].insertBefore(i.cloneNode(!0),a[t].firstChild)}},this.swatchClicked=function(t){t.preventDefault();const e=t.target,i=e.classList;i.contains('tb_gradient_swatch')?this.selectSwatch(e.dataset.id):i.contains('tf_delete_swatch')&&(this.removeSwatch(e.parentNode.dataset.id),themifyColorManager.updateColorSwatches('gradients'))},this.removeSwatch=function(t){const e=v.LightBox.el.querySelectorAll('.tb_gradient_swatch[data-id="'+t+'"]');for(let t=e.length-1;-1<t;--t)e[t].remove();delete themifyCM.gradients[t]},this.selectSwatch=function(t){const e=themifyCM.gradients[t],i=(this.setAngle(e.setting.angle),this.setRadialCircle(e.setting.circle),this.setType(e.setting.type),this.settings.gradient=e.gradient,this.update(),h.parentElement),s=i.tfClass('themify-gradient-type')[0],n=i.querySelector('input[type="checkbox"]'),a=i.tfClass('tb_angle_input')[0];s.value=e.setting.type,r.triggerEvent(s,'change'),n.checked=e.setting.circle,r.triggerEvent(n,'change'),a.value=e.setting.angle,r.triggerEvent(a,'change')},this.initSwatches=function(){const i=Object.keys(themifyCM.gradients);themifyCM.gradients=i.length?themifyCM.gradients:{};for(let t=0,e=i.length;t<e;++t)this.addSwatch(themifyCM.gradients[i[t]],!0)},this.__constructor()},$.ThemifyGradient.default='0% rgba(0,0,0, 1)|100% rgba(255,255,255,1)',$.fn.ThemifyGradient=function(t){return this.each(function(){void 0===$(this).data('themifyGradient')&&$(this).data('themifyGradient',new $.ThemifyGradient(this,t))})}})(jQuery,Themify,window.top.document,tb_app);