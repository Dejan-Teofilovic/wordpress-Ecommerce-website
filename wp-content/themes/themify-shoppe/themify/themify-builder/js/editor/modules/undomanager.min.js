((p,m,y,i,w)=>{'use strict';p.undoManager={isWorking:!1,isDisabled:!1,stack:[],state:new Map,index:-1,btnUndo:null,btnRedo:null,compactBtn:null,cid:null,type:w,init(){this.btnUndo=p.ToolBar.el.tfClass('undo')[0],this.btnRedo=p.ToolBar.el.tfClass('redo')[0],this.compactBtn=p.ToolBar.el.tfClass('compact_undo')[0],p.ToolBar.el.tfClass('menu_undo')[0].tfOn(y.click,e=>{e.target!==this.compactBtn&&(e.preventDefault(),e.stopPropagation(),this.doChange(e))}),y.isTouch||themifyBuilder.disableShortcuts||(i.document.tfOn('keydown',e=>{this.keypres(e)}),'visual'===p.mode&&m.tfOn('keydown',e=>{this.keypres(e)}))},start(e,t){if(!0===this.has(e))return console.warn('UndoManager:'+e+' is already started'),!1;this.type=e,this.cid=t,this.state.set(e,this.getCurrentState(e,t))},end(e){if(e=e||this.type,!1===this.has(e))return console.warn('UndoManager:'+e+' isn`t started'),!1;y.trigger('tb_undo_add',e);const t=this.getDiff(e,this.getState(e),this.getCurrentState(e,this.cid));0<Object.keys(t).length&&this.push(t),this.state.delete(e),this.type=this.cid=null},getState(e){return this.state.get(e)},has(e){return!!this.state.has(e)},clear(e){e===this.type&&(this.type=null),this.state.delete(e),this.cid=null},hasRedo(){return this.index<this.stack.length-1},hasUndo(){return-1<this.index},disable(){this.isDisabled=!0,this.btnUndo.classList.add('disabled'),this.btnRedo.classList.add('disabled'),this.compactBtn.classList.add('disabled')},enable(){this.isDisabled=!1,this.updateUndoBtns()},update(e){!0===e?--this.index:++this.index,this.updateUndoBtns(),p.pageBreakModule.countModules()},updateUndoBtns(){if(!0!==this.isDisabled){const e=this.hasUndo(),t=this.hasRedo();this.btnUndo.classList.toggle('disabled',!e),this.btnRedo.classList.toggle('disabled',!t),this.compactBtn.classList.toggle('disabled',!(e||t))}},reset(){this.stack=[],this.state.clear(),this.index=-1,this.updateUndoBtns()},doChange(e){if(!1===this.isWorking&&!1===this.isDisabled){this.isWorking=!0;const t=e.target.closest('.undo_redo');null===t||t.classList.contains('disabled')||this.changes(t.classList.contains('undo')),this.isWorking=!1}},getCurrentState(e){const i={},t={},n=p.breakpointsReverse;for(let e=n.length-1;-1<e;--e){let t=n[e],l=ThemifyStyles.getSheet(t).cssRules,s=ThemifyStyles.getSheet(t,!0).cssRules;i[t]={st:{},gs:{}};for(let e=l.length-1;-1<e;--e)i[t].st[l[e].selectorText]=l[e].style.cssText;for(let e=s.length-1;-1<e;--e)i[t].gs[s[e].selectorText]=s[e].style.cssText}const l=Array.from(p.Registry.items),s=new Map;for(let e=l.length-1;-1<e;--e)s.set(l[e][0],p.Helper.cloneObject(l[e][1].fields));return'style'!==e&&(t.builder=p.Builder.get().el.innerHTML),t.style=i,t.model=s,t},getDiff(s,i,n){let d=[];if('style'!==s){let t=m.createElement('template'),o=m.createElement('template'),e;if(t.innerHTML='<div>'+i.builder.replaceAll('class=""','').replaceAll('style=""','').replace(/class="\s*?"/,'').replace(/style="\s*?"/,'')+'</div>',o.innerHTML='<div>'+n.builder.replaceAll('class=""','').replaceAll('style=""','').replace(/class="\s*?"/,'').replace(/style="\s*?"/,'')+'</div>','move'===s){const b=t.content.querySelector('.tb_draggable_item');null!==b&&b.classList.contains('module_row')&&(e=b.dataset.cid)}t=p.Helper.cloneDom(t.content.firstChild,!0),o=p.Helper.cloneDom(o.content.firstChild,!0);let l=t.querySelectorAll('#tb_last_row_add_btn,.tb_dragger,.tb_backstretch');for(let e=l.length-1;-1<e;--e)l[e].remove();for(let e=(l=o.querySelectorAll('#tb_last_row_add_btn,.tb_dragger,.tb_backstretch')).length-1;-1<e;--e)l[e].remove();l=null;for(let i=t.children,n=i.length-1;-1<n;--n){let l=i[n].getAttribute('data-cid');if(l){let s=o.querySelector('.tb_'+l);if(null!==s){if(i[n].style.backgroundPosition=i[n].style.backgroundSize=s.style.backgroundPosition=s.style.backgroundSize='',i[n].getAttribute('style')||i[n].removeAttribute('style'),s.getAttribute('style')||s.removeAttribute('style'),i[n].isEqualNode(s)){if(l===e){let e=y.convert(o.children).indexOf(s);if(-1!==e&&e!==n){let e=i[n].previousElementSibling?i[n].previousElementSibling.getAttribute('data-cid'):0,t=s.previousElementSibling?s.previousElementSibling.getAttribute('data-cid'):0;d.push({old:e,new:t,cid:l,type:'row_sort'})}}continue}if(s.childElementCount===i[n].childElementCount){let t=i[n].children,l=s.children,c=!1;for(let e=t.length-1;-1<e;--e)if(!t[e].classList.contains('row_inner')&&!t[e].isEqualNode(l[e])){c=!0;break}if(!1===c){let e=i[n].querySelector('.row_inner'),t=s.querySelector('.row_inner');if(t.childElementCount===e.childElementCount&&t.cloneNode(!1).isEqualNode(e.cloneNode(!1))){let i=e.children,r=t.children,a=[];for(let s=i.length-1;-1<s;--s)if(!i[s].isEqualNode(r[s]))if(i[s].childElementCount===r[s].childElementCount&&i[s].cloneNode(!1).isEqualNode(r[s].cloneNode(!1))){let t=i[s].children,l=r[s].children;for(let e=t.length-1;-1<e;--e)if(!t[e].classList.contains('tb_holder')&&!t[e].isEqualNode(l[e])){a.push({old:i[s],new:r[s]}),c=!0;break}if(!1===c){let e=i[s].tfClass('tb_holder')[0],t=r[s].tfClass('tb_holder')[0];if(e.childElementCount===t.childElementCount){let o=e.children,d=t.children;for(let n=o.length-1;-1<n;--n)if(!o[n].isEqualNode(d[n])){if(o[n].childElementCount!==d[n].childElementCount||!o[n].cloneNode(!1).isEqualNode(d[n].cloneNode(!1))){a.push({old:i[s],new:r[s]});break}if(o[n].classList.contains('active_subrow')){let s=o[n].tfClass('module_subrow')[0],i=d[n].tfClass('module_subrow')[0];if(s.childElementCount===i.childElementCount&&s.cloneNode(!1).isEqualNode(i.cloneNode(!1))){let t=s.children,l=i.children;for(let e=t.length-1;-1<e;--e)if(!t[e].classList.contains('subrow_inner')&&!t[e].isEqualNode(l[e])){a.push({old:o[n],new:d[n]}),c=!0;break}if(!1===c){let e=s.tfClass('subrow_inner')[0],t=i.tfClass('subrow_inner')[0];if(e.childElementCount===t.childElementCount&&e.cloneNode(!1).isEqualNode(t.cloneNode(!1))){let n=e.children,o=t.children;for(let i=n.length-1;-1<i;--i)if(!n[i].isEqualNode(o[i]))if(n[i].childElementCount===o[i].childElementCount&&n[i].cloneNode(!1).isEqualNode(o[i].cloneNode(!1))){let t=n[i].children,l=o[i].children;for(let e=t.length-1;-1<e;--e)if(!t[e].classList.contains('tb_holder')&&!t[e].isEqualNode(l[e])){a.push({old:n[i],new:o[i]}),c=!0;break}if(!1===c){let e=n[i].tfClass('tb_holder')[0],s=o[i].tfClass('tb_holder')[0];if(e.childElementCount===s.childElementCount){let t=e.children,l=s.children;for(let e=t.length-1;-1<e;--e)if(!t[e].isEqualNode(l[e])){a.push({old:n[i],new:o[i]});break}}else a.push({old:n[i],new:o[i]})}}else a.push({old:n[i],new:o[i]})}else a.push({old:o[n],new:d[n]})}}else a.push({old:o[n],new:d[n]})}else{let t=o[n].children,l=d[n].children;for(let e=t.length-1;-1<e;--e)if(!t[e].isEqualNode(l[e])){a.push({old:o[n],new:d[n]});break}}}}else a.push({old:i[s],new:r[s]})}}else a.push({old:i[s],new:r[s]});if(0<a.length){for(let e=a.length-1;-1<e;--e)d.push(a[e]);continue}}}}}if(s)d.push({new:s,old:i[n]});else{let e=i[n].previousElementSibling?i[n].previousElementSibling.getAttribute('data-cid'):0;d.push({old:i[n],prevCid:e})}}}for(let s=o.children,i=s.length-1;-1<i;--i){let e=s[i].getAttribute('data-cid');if(null===t.querySelector('.tb_'+e)){let t=s[i].getAttribute('data-old-cid'),l=!1;if(t){s[i].removeAttribute('data-old-cid');for(let e=d.length-1;-1<e;--e)if(d[e].old!==w&&d[e].old.getAttribute('data-cid')===t){d[e].new=s[i],l=!0;break}}if(!1===l){let e={new:s[i]};s[i].classList.contains('module_row')&&(e.prevCid=s[i].previousElementSibling?s[i].previousElementSibling.getAttribute('data-cid'):0),d.push(e)}}}t=o=null}const o=new Map,r=n.model,a=i.model;for(let[t,l]of a){let e=r.get(t);e?(p.Helper.compareObject(l,e)&&o.set(t,{old:l,new:e}),r.delete(t)):o.set(t,{old:l}),a.delete(t)}for(let[e,t]of r)o.set(e,{new:t});let c=i.style,h=n.style,u={},f=i=>{const n={};for(let s=(i=i.split('; ')).length-1;-1<s;--s){let e=i[s].indexOf(':'),t=i[s].substring(0,e),l=(n[t]=i[s].substring(e+1).trim(),n[t].length);if(';'===n[t][l-1])n[t]=n[t].slice(0,-1);else if('"'===n[t][l-1]&&';'===n[t][l-2]){let e=l-2;n[t]=n[t].substring(0,e)+n[t].substring(1+e)}}return n},g=(t,l)=>{let o={old:{},new:{}};for(let n in t)if(l[n]!==w){if(l[n]!==t[n]){let s=f(t[n]),i=f(l[n]);for(let l in s)if(i[l]!==s[l]){let e=s[l].trim(),t=i[l];(t=t!==w?t.trim():'')!==e&&(o.old[n]===w&&(o.old[n]={}),o.new[n]===w&&(o.new[n]={}),o.old[n][l]=e,o.new[n][l]=t)}for(let t in i)if(s[t]===w){let e=i[t].trim();o.old[n]===w&&(o.old[n]={}),o.new[n]===w&&(o.new[n]={}),o.old[n][t]='',o.new[n][t]=e}}}else o.old[n]=f(t[n]),o.new[n]='';for(let e in l)t[e]===w&&(o.new[e]=f(l[e]),o.old[e]='');return 0===Object.keys(o.old).length&&delete o.old,0===Object.keys(o.new).length&&delete o.new,o};for(let l in c)if(h[l]!==w){let e=g(c[l].st,h[l].st),t=g(c[l].gs,h[l].gs);0<Object.keys(e).length&&(u[l]={st:e}),0<Object.keys(t).length&&(u[l]={gs:t})}for(let l in h)if(c[l]===w){let e=g({},h[l].st),t=g({},h[l].gs);0<Object.keys(e).length&&(u[l]={st:e}),0<Object.keys(t).length&&(u[l]={gs:t})}n=h=c=null;const e={};return 0<Object.keys(u).length&&(e.styles=u),0<o.size&&(e.model=o),'style'!==s&&0<d.length&&(e.html=d),0<Object.keys(e).length&&(e.type=s),e},push(e){p.editing=!1,this.stack.splice(this.index+1,this.stack.length-this.index),this.stack.push(e),this.index=this.stack.length-1,this.updateUndoBtns(),y.trigger('add_undo'),p.Builder.get().isSaved=!1},keypres(e){if(!1===this.isWorking&&!1===this.isDisabled&&(!0===e.ctrlKey||!0===e.metaKey)){const t=m.activeElement.tagName,l=i.document.activeElement.tagName,s=e.code;'INPUT'!==t&&'TEXTAREA'!==t&&'INPUT'!==l&&'TEXTAREA'!==l&&('KeyY'===s||'KeyZ'===s&&!0===e.shiftKey?(e.preventDefault(),this.hasRedo()&&this.changes(!1)):'KeyZ'===s&&(e.preventDefault(),this.hasUndo()&&this.changes(!0)))}},changes(e){if(p.ActionBar.clearClicked(),null!==p.activeModel&&('visual'!==p.mode||!m.activeElement.contentEditable&&p.activeModel.contains(m.activeElement)))p.LightBox.save().then(()=>{this.changes(!0)}).catch(e=>{});else{const t=!0===e?0:1,l=this.stack[this.index+t];if(l!==w){const s=!0===e?'old':'new';l.styles&&this.styleChanges(l.styles,s,!l.html),l.html&&this.domChanges(l.html,s,l.type),l.model&&this.modelChanges(l.model,s),this.update(e)}}},styleChanges(d,r,a){const c=new Set;for(let o in d)for(let t in d[o]){let l=ThemifyStyles.getSheet(o,'gs'===t),n=l.cssRules;for(let e in d[o][t][r]){let s=d[o][t][r][e],i=p.Utils.findCssRule(n,e);if(''===s)!1!==i&&n[i]!==w&&l.deleteRule(i);else if(!1===i||n[i]===w){let t='';for(let e in s)t+=e+':'+s[e]+';';l.insertRule(e+'{'+t+';}',n.length)}else for(let l in s){let e=s[l].trim(),t=''!==e&&-1!==e.indexOf('!important')?'important':'';t&&(e=e.replace('!important','').trim()),n[i].style.setProperty(l,e,t)}!0===a&&c.add(e)}}if(0<c.size)for(let t of c){let e=m.querySelector(t);e&&p.Utils.runJs(e)}},domChanges(i,n,e){try{const o=p.Registry,d=p.Builder.get().el;for(let s=i.length-1;-1<s;--s)if(i[s][n]!==w)if('row_sort'===i[s].type){let l=d.querySelector('[data-cid="'+i[s].cid+'"]');if(l){let t=i[s][n];if(0===t)d.prepend(l);else{let e=d.querySelector('[data-cid="'+t+'"]');e&&e.after(l)}}}else{let e=i[s][n],t=e.dataset.cid,l=d.querySelector('[data-cid="'+t+'"]');if(null===l&&(t='old'===n&&i[s].new!==w?i[s].new.dataset.cid:'new'===n&&i[s].old!==w?i[s].old.dataset.cid:null,null===(l=null!==t?d.querySelector('[data-cid="'+t+'"]'):l)&&i[s].prevCid!==w))if(l=m.createElement('div'),0===i[s].prevCid)d.prepend(l);else{let e=d.querySelector('[data-cid="'+i[s].prevCid+'"]');if(e===w)continue;e.after(l)}if(l!==w){e=e.cloneNode(!0);let s=y.convert(e.querySelectorAll('[data-cid]'));s.unshift(e);for(let l=s.length-1;-1<l;--l){let e=s[l].getAttribute('data-cid'),t=o.get(e);'module'===t.type&&s[l].tfClass('module')[0]===w?s[l].remove():t.el=s[l]}l.replaceWith(e),p.Utils.runJs(e),y.trigger('undo',[e,'old'===n])}}else if('old'===n&&i[s].new!==w||'new'===n&&i[s].old!==w){let e='old'===n?i[s].new:i[s].old,t=d.querySelector('[data-cid="'+e.dataset.cid+'"]');null!==t&&t.remove()}}catch(e){}},modelChanges(e,s){const i=p.Registry;for(let[t,l]of e)if(l[s]!==w){let e=i.get(t);e&&(e.fields=p.Helper.cloneObject(l[s]))}}},y.on('tb_toolbar_loaded',()=>{p.undoManager.init()},!0,!(!p.ToolBar||!0!==p.ToolBar.isLoaded))})(tb_app,document,Themify,window.top,void 0);