((b,f,g,y)=>{'use strict';b.LayoutPart=class{constructor(t){this.id=t}edit(){const t=this.id,m=b.LayoutPart;return new Promise(async(u,_)=>{const s=b.Registry.get(t);if(s){await b.LightBox.save(),b.ActionBar.clear();let n=s.el.closest('.active_module'),c=n.tfClass('themify_builder_content')[0],h=c.dataset.postid,t=async()=>{g.body.classList.add('tb_layout_part_edit'),y.document.body.classList.add('tb_layout_part_edit'),b.ToolBar.el.classList.add('tb_layout_part_edit');const t=b.Builder.get(),e=g.createElement('div'),s=n.closest('.row_inner').tfClass('active_module');e.className='tb_overlay tf_overflow tf_abs tf_w tf_h',t.el.prepend(e);for(let t=s.length-1;-1<t;--t)s[t]!==n&&s[t].prepend(e.cloneNode());const o='themify_builder_content-'+(ThemifyStyles.builder_id=h),l=[];for(let t=g.tfClass(o),s=t.length-1;-1<s;--s){let e=t[s].closest('.active_module');if(e){let t=e.tfClass('themify-builder-generated-css')[0];t&&t.setAttribute('disabled','disabled')}}t.el.classList.remove('tb_active_builder'),n.classList.add('tb_active_layout_part'),n.classList.remove('active_module','module');const a=n.closest('.tb_holder'),r=c.offsetHeight;a.classList.add('tb_layout_part_parent'),a.classList.remove('tb_holder'),a.closest('.module_row').classList.add('tb_active_layout_part_row'),this.el=n;let i=new b.Builder(c,b.Helper.correctBuilderData(m.cache[h].builder_data),m.cache[h].custom_css);for(let t=i.el.querySelectorAll('[data-cid]'),e=t.length-1;-1<e;--e)l.push(t[e].dataset.cid);i.el.style.height=r+'px';for(let t=i.el.children,e=t.length-1;-1<e;--e)t[e].dataset.cid||t[e].remove();try{await b.bootstrap(l),i.el.style.height='';try{await b.correctColumnPaddings()}catch(t){}b.Utils.runJs(i.el),b.Registry.trigger(i,'tb_init'),await b.Spinner.showLoader('done'),this.toolbar.getRootNode().host.classList.remove('tf_hide'),b.activeModel=null,this.toolbar.tfOn(f.click,t=>{t.stopPropagation();const e=t.target;e.closest('a')&&t.preventDefault(),e.closest('.tf_close')?this.close():e.closest('.save')?this.save():e.closest('.layout')?b.ToolBar.initLayout(t):e.closest('.import')?b.ToolBar.initImport(t):e.closest('.export')?b.ToolBar.initExport(t):e.closest('.undo_redo')?b.undoManager.doChange(t):e.closest('.custom_css')&&b.ToolBar.addCustomCSS(t)});const d=[];for(let t=b.undoManager.stack,e=0,s=t.length;e<s;++e)d[e]=b.Helper.cloneObject(t[e]);this.undo=d,b.undoManager.btnUndo=this.toolbar.tfClass('undo')[0],b.undoManager.btnRedo=this.toolbar.tfClass('redo')[0],b.undoManager.reset(),n=i=c=h=null,f.isTouch||e.tfOn('dblclick',t=>{t.preventDefault(),t.stopImmediatePropagation(),this.save().then(()=>{this.close()})},{once:!0}),u()}catch(t){b.Spinner.showLoader('error'),this.toolbar.getRootNode().host.remove(),this.html=this.toolbar=null,_()}},e=()=>{this.html=b.Helper.cloneDom(n).innerHTML;const t=g.createElement('div'),e=g.tfId('tmpl-small_toolbar'),s=g.createDocumentFragment(),o=b.ToolBar.el.getRootNode().querySelectorAll('style,#tf_svg');t.id='tb_small_toolbar_root',t.className='tf_w tf_hide',t.attachShadow({mode:'open'}).appendChild(e.content.cloneNode(!0));for(let t=0,e=o.length;t<e;++t)s.appendChild(o[t].cloneNode(!0));t.shadowRoot.prepend(s),this.toolbar=t.shadowRoot.tfId('toolbar'),n.prepend(t)};if(void 0!==m.cache[h])e(),t();else try{const o=await b.LocalFetch({action:'tb_layout_part_swap',bid:h});if(!o.builder_data)throw'Error';(m.cache[h]=o).used_gs&&(b.GS.styles=ThemifyStyles.extend(!0,{},o.used_gs,b.GS.styles)),e(),t()}catch(t){b.Spinner.showLoader('error'),this.toolbar.getRootNode().host.remove(),this.html=this.toolbar=null,_()}}else _()})}restore(){this.toolbar.getRootNode().host.remove(),b.LightBox.close();const t=this.el.closest('.tb_layout_part_parent'),e=b.Builder.get();this.el.classList.add('active_module','module'),this.el.classList.remove('tb_active_layout_part'),t.classList.add('tb_holder'),t.classList.remove('tb_layout_part_parent'),t.closest('.module_row').classList.remove('tb_active_layout_part_row'),e.destroy();for(let t=g.tfClass('tb_overlay'),e=t.length-1;-1<e;--e)t[e].remove();b.undoManager.stack=this.undo,b.undoManager.index=this.undo.length-1,b.undoManager.btnUndo=b.ToolBar.el.tfClass('undo')[0],b.undoManager.btnRedo=b.ToolBar.el.tfClass('redo')[0],b.undoManager.updateUndoBtns(),ThemifyStyles.builder_id=b.Builder.get().id,b.ActionBar.clear(),b.Builder.get().el.classList.add('tb_active_builder','tf_rel'),g.body.classList.remove('tb_layout_part_edit'),y.document.body.classList.remove('tb_layout_part_edit'),b.ToolBar.el.classList.remove('tb_layout_part_edit'),f.trigger('tb_resotre_layout_part'),this.undo=this.html=this.el=b.activeModel=this.cssFile=b.LayoutPart.item=null}async close(){if(!1===b.Builder.get().isSaved&&b.undoManager.hasUndo()){const t=await b.LiteLightBox.confirm({msg:themifyBuilder.i18n.layoutEditConfirm});if('yes'!==t)return!1}const r='themify_builder_content-'+b.Builder.get().id;if(this.cssFile){b.Spinner.showLoader();const e=b.Registry.get(this.el.dataset.cid);try{await e.trigger('ajax',Object.assign({unsetKey:!0},e.get('mod_settings')));const i=e.el.tfClass('themify_builder_content')[0].innerHTML;let a;!0!==this.cssFile&&((a=g.createElement('link')).href=this.cssFile,a.rel='stylesheet',a.className='themify-builder-generated-css');for(let t=this.undo.length-1;-1<t;--t){let l=this.undo[t].html;if(l)for(let o=l.length-1;-1<o;--o)for(let t=['old','new'],s=t.length-1;-1<s;--s){let e=l[o][t[s]];if(e){let t=e.tfClass(r)[0];if(t){t.innerHTML=i;let s=t.closest('.module');for(let t=s.children,e=t.length-1;-1<e;--e)'LINK'===t[e].tagName&&t[e].classList.contains('themify-builder-generated-css')&&t[e].remove();a&&s.prepend(a.cloneNode(!0))}}}}this.restore();for(let s=g.tfClass(r),o=s.length-1;-1<o;--o){let t=s[o].closest('.module');for(let t=s[o].children,e=t.length-1;-1<e;--e)'LINK'===t[e].tagName&&t[e].classList.contains('themify-builder-generated-css')&&t[e].remove();a&&t.prepend(a.cloneNode(!0)),e.id!==t.dataset.cid&&(s[o].innerHTML=i,b.Utils.runJs(s[o]))}b.Spinner.showLoader('hide')}catch(t){throw b.Spinner.showLoader('error'),t}}else{this.html&&(this.el.innerHTML=this.html),this.restore();for(let t=g.tfClass(r),s=t.length-1;-1<s;--s){let e=t[s].closest('.active_module');if(e){let t=e.tfClass('themify-builder-generated-css')[0];t&&t.removeAttribute('disabled')}}b.Utils.runJs(this.el)}}async save(){const t=this.toolbar.tfClass('save_wrap')[0].classList;try{if(t.contains('disabled'))throw'isWorking';t.add('disabled'),await b.LightBox.save(),b.Spinner.showLoader();const e=b.Builder.get(),s=e.id,o=b.LayoutPart,l=await e.save();o.cache[s]={builder_data:l.builder_data},e.custom_css&&(o.cache[s].custom_css=e.custom_css),this.cssFile=l.css_file||!0,this.html=null}catch(t){}t.remove('disabled')}},b.LayoutPart.cache={},b.OverlayContent=class extends b.LayoutPart{constructor(t){super(t)}}})(tb_app,Themify,document,window.top);