(($,a,i)=>{'use strict';const t=function(){this.form=a.tfId('tb_admin_new_gs'),this.loadAddNewForm(),this.addNew(),this.deleteStyle(),this.restore(),this.scalePreview(),this.importFile()};t.prototype.addNew=function(){const t=a.tfClass('tb_admin_save_gs')[0];t&&t.tfOn('click',e=>{e.preventDefault(),this.validateForm()?(e.target.text=i.i18n.creating,$.ajax({type:'POST',url:i.ajaxurl,dataType:'json',data:{action:'tb_save_custom_global_style',nonce:i.nonce,form_data:$(this.form).serialize()},success(t){'failed'===t.status?(alert(t.msg),e.target.text=i.i18n.create):'success'===t.status?window.location=t.url:e.target.text=i.i18n.create}})):alert(i.i18n.formValid)})},t.prototype.validateForm=function(){let n=!0;return $.each($(this.form).serializeArray(),function(t,e){if(''==e.value)return n=!1}),n},t.prototype.loadAddNewForm=function(){const t=$('.tb_add_new_gs');if(0!==t.length){t.magnificPopup({type:'inline',midClick:!0,callbacks:{close(){a.tfId("tb_admin_new_gs").reset()}}});const e=a.tfClass('tb_gs_export');for(let t=e.length-1;-1<t;--t)e[t].tfOn('click',n=>{n.preventDefault(),Themify.fetch({action:'tb_get_gs_post',id:n.target.dataset.id,nonce:i.nonce}).then(e=>{this.loadJsZip().then(()=>{let t=new JSZip;t.file('builder_gs_data_export.txt',JSON.stringify(e)),t.generateAsync({type:'blob'}).then(t=>{const e=n.target.dataset.title+'_export_.zip';this.donwload(t,e)})})})})}},t.prototype.deleteStyle=function(){const t=$('.tb_remove_gs');0!==t.length&&t.on('click',function(t){t.preventDefault();const e=$(this),n=e.parents('.tb_admin_gs_list').data('list'),a='publish'===n?i.i18n.deleteConfirm:i.i18n.deleteConfirm2;confirm(a)&&(e.parents('.tb_gs_element').fadeOut(),$.ajax({type:'POST',url:i.ajaxurl,dataType:'json',data:{action:'tb_delete_global_style',nonce:i.nonce,status:n,id:e.attr('data-id')},success(t){'failed'===t.status&&(alert(t.msg),e.parents('.tb_gs_element').fadeIn())}}))})},t.prototype.restore=function(){const t=$('.tb_gs_restore');0!==t.length&&t.on('click',function(t){t.preventDefault();const e=$(this);e.parents('.tb_gs_element').fadeOut(),$.ajax({type:'POST',url:i.ajaxurl,dataType:'json',data:{action:'tb_restore_global_style',nonce:i.nonce,id:e.attr('data-id')},success(t){'failed'===t.status&&(alert(t.msg),e.parents('.tb_gs_element').fadeIn())}})})},t.prototype.scalePreview=function(){$(".themify_builder_content").each(function(){let t=$(this),e=t.parent(),n=Math.min(e.width()/t.outerWidth(),e.height()/t.outerHeight());t.css({transform:"translate(-50%, -50%) scale("+n+")"})})},t.prototype.importFile=function(){const t=a.tfClass('tb_import_gs')[0];t&&t.tfOn('click',t=>{t.preventDefault();const e=a.createElement('input');e.type='file',e.accept='.zip,.txt',e.tfOn('change',function(t){const e=this.files[0],n=function(t){Themify.fetch({action:'tb_import_gs_posts_ajax',data:t,nonce:i.nonce}).then(t=>{location.reload()})};if('text/plain'===e.type){const a=new FileReader;a.tfOn('loadend',function(t){if(this.readyState!==FileReader.DONE)throw Error(i.i18n.invalid_file);n(t.target.result)},{passive:!0,once:!0}).readAsText(e)}else'application/x-zip-compressed'!==e.type&&'application/zip'!==e.type||this.loadJsZip().then(()=>{const t=new JSZip;t.loadAsync(e).then(t=>{const e=t.files;if(!e||!e['builder_gs_data_export.txt'])throw Error(i.i18n.missing_file);t.file('builder_gs_data_export.txt').async('text').then(t=>{n(t)})}).catch(t=>{throw t})})}).click()})},t.prototype.loadJsZip=()=>Themify.loadJs(Themify.url+'js/admin/jszip.min',!!win.JSZip,'3.10.1'),t.prototype.donwload=(t,e)=>{let n=a.createElement('a');n.download=e,n.rel='noopener',n.href=URL.createObjectURL(t),setTimeout(()=>{URL.revokeObjectURL(n.href),n=null},7e3),n.click()},new t})(jQuery,document,themifyGlobalStylesVars);